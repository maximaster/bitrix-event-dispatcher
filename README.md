# maximaster/bitrix-event-dispatcher

Позволяет использовать [symfony/event-dispatcher](https://packagist.org/packages/symfony/event-dispatcher)
для регистрации обработчиков на события Битрикс, создавая при этом под каждое
событие собственный класс.

## Зачем?

1. если ваше приложение использует и Symfony и Битрикс, то вы уже используете
   event-dispatcher и будет удобнее регистрировать обработчики единым образом;
2. вы хотите работать с типизированными объектами событий, которые смогут
   предоставить удобный интерфейс к своим данным.

## Как это работает

1. запускается хит;
2. в процессе кто-то требует сервис EventDispatcherInterface;
3. контейнер создаёт этот сервис и благодаря штатному функционалу Symfony
   (RegisterListenersPass) добавляет в него слушателей (addListener);
4. для тех вызовов addListener, которые регистрируют событие с интерфейсом
   \Maximaster\BitrixEvents\Contract\Event дополнительно вызывается код, который
   регистрирует обработчик события Битрикс. Это всегда ForwardListener
5. Битрикс вызывает событие
6. приходим в ForwardListener::__invoke;
7. из аргументов пришедших в событие создаётся объект события из этого пакета;
8. этот объект события отправляется в Symfony EventDispatcherInterface;
9. штатный функционал Symfony отрабатывает и вызывает обработку события, которое
   было зарегистрировано на шаге 3.

## Ограничения и нюансы

1. Даже если вы регистрируете 100 обработчиков на одно и то же событие с помощью
   библиотеки, то в Битриксе будет зарегистрирован лишь один (ForwardListener)
   обработчик. Как следствие, отсортировать порядок выполнения обработчиков,
   которые сделаны в рамках этой библиотеки, однако, отсортировать их выполнения
   относительно других обработчиков невозможно;
2. Если событие старого типа позволяет менять данные, то важно не только
   принимать в конструкторе данные по ссылке, но и по ссылке сохранять эти
   данные в свойство, иначе редактирование будет невозможно.

## Доработка библиотеки

* установите [devbox](https://www.jetify.com/devbox), либо самостоятельно
  воспроизведите окружение, которое через него описано (см. `devbox.json`);
* убедитесь, что линтеры не выдают ошибок (`devbox run lint`).
